services:
  # ================================
  # DATABASE (MySQL)
  # ================================
  db:
    profiles: ["local"]
    image: mysql:8.0
    container_name: moonlit_db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      # Persistent database storage
      - db_data:/var/lib/mysql
      # Initialize database with SQL file
      - ./docker/mysql/init:/docker-entrypoint-initdb.d
    ports:
      - "${DB_EXTERNAL_PORT}:3306"
    networks:
      - moonlit_network
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "localhost",
          "-u",
          "root",
          "-p${DB_ROOT_PASSWORD}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ================================
  # PHP APPLICATION (Apache + PHP-FPM)
  # ================================
  web:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
      args:
        PHP_VERSION: ${PHP_VERSION}
    container_name: moonlit_web
    restart: unless-stopped
    environment:
      # Database connection
      DB_HOST: ${DB_HOST}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_PORT: ${DB_PORT}

      # Application settings
      APP_ENV: ${APP_ENV}
      APP_DEBUG: ${APP_DEBUG}
      APP_URL: ${APP_URL}
      API_BASE_URL: ${API_BASE_URL}

      # PHP settings
      PHP_MEMORY_LIMIT: ${PHP_MEMORY_LIMIT}
      PHP_UPLOAD_MAX_FILESIZE: ${PHP_UPLOAD_MAX_FILESIZE}
      PHP_POST_MAX_SIZE: ${PHP_POST_MAX_SIZE}
    volumes:
      # Mount application code
      - ./public:/var/www/html
      - ./src:/var/www/src

      # Persistent uploads
      - uploads_data:/var/www/html/uploads

      # Apache configuration (if needed)
      - ./docker/apache:/etc/apache2/sites-available
    ports:
      - "${WEB_PORT}:80"
    networks:
      - moonlit_network

# ================================
# NETWORKS
# ================================
networks:
  moonlit_network:
    driver: bridge

# ================================
# VOLUMES (Persistent Data)
# ================================
volumes:
  # Database storage (persists across container restarts)
  db_data:
    driver: local

  # Uploaded files storage (receipts, images, etc.)
  uploads_data:
    driver: local
